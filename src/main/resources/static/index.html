<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Registro de Token FCM</title>
    <!-- Cargar librerías de Firebase (versión compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>
</head>
<body>
<h1>Registro de Token FCM con Thymeleaf</h1>

<!-- Campo para mostrar el username generado -->
<div>
    <label for="username">Username:</label>
    <input type="text" id="username" readonly />
</div>

<!-- Botón para solicitar permiso y registrar el token -->
<div>
    <button id="getTokenButton">Obtener Token</button>
</div>

<!-- Mensaje de retroalimentación -->
<div id="message" style="margin-top: 20px; color: green;"></div>

<script>
    // Configuración de Firebase: reemplaza estos valores por los de tu proyecto
    var firebaseConfig = {
        apiKey: "AIzaSyAQRszqx520uCEyQ8dgultv4t9wbpP7K5A",
        authDomain: "project-a16f1.firebaseapp.com",
        projectId: "project-a16f1",
        storageBucket: "project-a16f1.appspot.com",
        messagingSenderId: "126128411502",
        appId: "1:126128411502:web:30b509cb2b3c2faa40677f"
    };

    // Inicializar Firebase
    console.log("Inicializando Firebase...");
    firebase.initializeApp(firebaseConfig);
    console.log("Firebase inicializado correctamente.");
    const messaging = firebase.messaging();

    // Función para solicitar permiso, obtener token y enviar datos al backend
    function requestNotificationPermission(username) {
        console.log("Solicitando permiso para notificaciones...");
        Notification.requestPermission().then((permission) => {
            if (permission === 'granted') {
                console.log('Permiso para notificaciones concedido.');
                messaging.getToken({ vapidKey: "BLBKY_0m2afUPOI2BpPd4plGcxkxzs_eS6IEHLJO9aGNvy0SAqbP16_ZkAQImPUbpaqF1pLfdLMFMv10Azos3pg" })
                    .then((currentToken) => {
                        if (currentToken) {
                            console.log('Token FCM obtenido:', currentToken);
                            // Enviar el username y token al backend
                            fetch('/api/registerMessagingToken', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    username: username,
                                    token: currentToken
                                })
                            })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error("Error en la solicitud: " + response.statusText);
                                    }
                                    return response.text();
                                })
                                .then(data => {
                                    console.log('Respuesta del servidor:', data);
                                    document.getElementById('message').innerText = data;
                                })
                                .catch((err) => {
                                    console.error('Error al enviar el token al servidor:', err);
                                    document.getElementById('message').innerText = "Error al enviar el token";
                                });
                        } else {
                            console.log('No se pudo obtener el token FCM.');
                            document.getElementById('message').innerText = "No se pudo obtener el token FCM";
                        }
                    })
                    .catch((err) => {
                        console.error('Error al obtener el token FCM:', err);
                        document.getElementById('message').innerText = "Error al obtener el token FCM";
                    });
            } else {
                console.log('Permiso para notificaciones denegado.');
                document.getElementById('message').innerText = "Permiso para notificaciones denegado";
            }
        });
    }

    // Al cargar la página, generar el username y mostrarlo en el input
    console.log("Cargando página...");
    window.addEventListener('load', () => {
        console.log("Solicitando username...");
        fetch('/api/generateUsername')
            .then(response => {
                if (!response.ok) {
                    throw new Error("Error en la solicitud: " + response.statusText);
                }
                return response.text();
            })
            .then(username => {
                console.log("Username generado:", username);
                document.getElementById('username').value = username;
            })
            .catch(err => {
                console.error("Error generando username:", err);
                document.getElementById('message').innerText = "Error generando username";
            });
    });

    // Al hacer clic en el botón, usar el username del input para solicitar el token y registrarlo
    document.getElementById('getTokenButton').addEventListener('click', () => {
        const username = document.getElementById('username').value;
        if (username) {
            console.log("Username encontrado:", username);
            requestNotificationPermission(username);
        } else {
            console.error("No hay username generado.");
            document.getElementById('message').innerText = "No hay username generado";
        }
    });
</script>
</body>
</html>